<% provide :page_title, @title || "Title" %>
<%# https://github.com/mlibrary/heliotrope/issues/1228 %>
<% content_for :head do %>
  <meta name="turbolinks-cache-control" content="no-cache">
  <% if @monograph_presenter.webgl? %>
    <%
# load what we need to show the webgl/3-d model if needed
webgl_id = @monograph_presenter.webgl_id
webgl = if Dir.exist?(UnpackService.root_path_from_noid(webgl_id, 'webgl'))
          Webgl::Unity.from_directory(UnpackService.root_path_from_noid(webgl_id, 'webgl'))
        else
          Webgl::Unity.null_object
        end
@unity_loader = "/webgl/#{webgl_id}/#{webgl.unity_loader}"
@unity_json = "/webgl/#{webgl_id}/#{webgl.unity_json}"
    %>
       <!-- browser detection here -->
     <script src="<%= @unity_loader %>"></script>
	   <script>
 	   // this has to go right after @unity_loader is loaded to guarantee no random JS errors get alert-boxed
      	UnityLoader.Error.handler = function(e, t){
          // NOP to stop the nuisance alert boxes for *all* (even non-Unity) JS errors
        }
	   </script>
  <% end %>
<% end %>

<% provide :body do %>
  <% if defined? @presenter.file_set_coins_title %>
    <span class="Z3988" title="<%= @presenter.file_set_coins_title %>"></span>
  <% end %>

  <div id="epub" class="<%= @subdomain %>">
    <div id="reader"></div>

    <script type="text/javascript">
      if ( true ) {
        //$("body").addClass("reading");
        var reader = cozy.reader('reader', {
          href: "<%= "#{main_app.epub_url.gsub!(/\?.*/, '')}/" %>",
          download_links: <%= @epub_download_presenter.download_links.to_json.html_safe %>,
          metadata: {
            doi: '<%= @citable_link %>',
            // TODO: iterate all creator given and family names for monograph
            // creator: [
            //    ''
            // ],
            // TO-DO: we currently don't store location metadata in the monograph
            // record. Should we? Can we rely on all EPUBs having location?
            location: 'Ann Arbor, MI'
          }
        });

        // Close reader/Return to previous screen widget
        cozy.control.widget.button({
          region: 'top.header.left',
          data: { label: '<i class="icon-x oi" data-glyph="x" aria-hidden="true"></i>'},
          template: '<button class="button--sm cozy-close" data-toggle="button" data-slot="label" aria-label="Close reader"></button>',
          onClick: function() { window.location = "<%= "#{@back_link}" %>"; }
        }).addTo(reader);
        // Press brand widget
        // TODO: only show logo for publishers that also have CSS overrides. Currently only HEB has this.
        <% if defined? @subdomain %>
        // only include logos for heb, nyupress, and gabii at this point
        <% if %w[heb nyupress gabii].include? @subdomain %>
        cozy.control.widget.panel({
          region: 'top.header.left',
          template: '<div class="logo"><%= link_to (image_tag logo(@subdomain), role: 'link', alt: @subdomain + ' catalog on Fulcrum'), URI.join(main_app.root_url, @subdomain).to_s %>',
          data: { title: "<%= @subdomain %>" }
        }).addTo(reader);
        <% end %>
        <% end %>
        // Book/chapter title widget
        cozy.control.title({ region: 'top.header.left' }).addTo(reader);

        <% if @monograph_presenter.webgl? %>
        cozy.control.widget.panel({
          region: 'top.header.right',
          template: '<div class="alert alert-info alert-dismissable" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><span class="message"><strong>Access to the full publication is free through June 2018.</strong> Afterwards, you can purchase access <a href="https://www.press.umich.edu/9231782/mid_republican_house_from_gabii">here</a>.</span></div>'
        }).addTo(reader);
        <% end %>

        // Table of contents widget
        cozy.control.contents({ region: 'top.toolbar.left' }).addTo(reader);

        // Webgl/3-D model
        <% if @monograph_presenter.webgl? %>

        var gameInstance;
        var gameReady = false;

        // a flag to allow the panel to be open with `a11y_on` the first time only for users with an incompatible...
        // device or browser (heliotropeIncompatibleWebGlUser === true)
        var firstLaunchWebGlEpub = false;

        // load the game on launch of e-reader
        reader.on('ready', function() {
          open_panel();
          // the a11y state disables the "3D MODEL" button and hides the WebGL panel. These are things we want for...
          // incompatible device/browser users also, but initially we *do* want them to see the panel with the...
          // incompatibility message as an "easy" way to inform them about the problem (firstLaunchWebGlEpub flag)
          if(heliotropeIncompatibleWebGlUser === true) {
            firstLaunchWebGlEpub = true;
            a11y_on();
          }
        })

        // open panel function and initiate game if not initiated
        var open_panel = function() {
          var $main = $(".cozy-module-main");
          var $book = $(".cozy-module-book-cover");
          close_panel();
          $("body").addClass("panel-open panel-right");

          var $panel = $('.special-panel');

          if (! $panel.length) {

            var mobileUserMessage = '';
            if(heliotropeIncompatibleWebGlUser === true) {
              mobileUserMessage = '<div id="epub-webgl-mobile-message">Sorry, it looks like your device or browser is not compatible with WebGL.<br />Please check our <a href="http://hdl.handle.net/2027/fulcrum.9231782/about">compatibility requirements</a>.</div>';
            }

            var $panelContent =
              '<div class="special-panel" aria-hidden="false">' +
                '<div class="panel-control">' +
                  '<button class="button--sm webgl-close" data-toggle="button" data-slot="label" aria-label="Close 3-D Model" onclick="close_panel();">' +
                    '<i class="icon-x oi" data-glyph="x" aria-hidden="true"></i>' +
                  '</button>' +
                '</div>' +
                '<div class="webgl-content">' +
                  '<div id="gameContainer" tabindex="0">' +
                    mobileUserMessage +
                  '</div>' +
                '</div>' +
                '<div class="panel-info">' +
                  '<h2>Gabii Area B 3D Model</h2>' +
                  '<p><strong>DOI: https://doi.org/10.3998/mpub.9231782.model</strong></p>' +
                  '<p>This interactive section of the publication includes 3D models, descriptions, and links to the online database, and complements the narrative text. Interaction with this content is essential to engaging with our interpretation of the Tincu house. Readers are encouraged both to follow the narrative laid out in the text through the model and data, and to explore the 3D content and database freely.' +
                  '</p>' +
                '</div>' +
              '</div>';
            $panel = $($panelContent).appendTo($main);
          } else {
            $panel.show();
            $('.special-panel').prop('hidden', false);
            $('.special-panel').attr('aria-hidden', 'false');
          }

          // mobile users won't be loading the 3D content so this stuff isn't required
          if (heliotropeIncompatibleWebGlUser === false) {
            var options = {};

            var h = $panel.height();
            var w = $panel.width();

            // the game has to have a specific aspect ratio or it looks distorted
            var r = w / 1024;
            options.width = w + 'px';
            options.height = Math.ceil(600 * r) + 'px';

            if (!gameInstance) {
              gameInstance = UnityLoader.instantiate("gameContainer", "<%= "#{@unity_json}" %>", options);
            } else {
              // resize the webGL canvas
              resize_webgl();
            }
          }

          // resize EPUB
          setTimeout(function() {
            window.dispatchEvent(new Event('resize'));
          }, 0);

          panel_toggle.state('close-webgl');
        } // end open_panel

        // close panel function
        var close_panel = function() {
          var $panel = $('.special-panel');
          if ($panel.length) {
            $('.special-panel').hide();
            $('body').removeClass('panel-open');
            $('body').removeClass('panel-right');
            $('.special-panel').prop('hidden', true);
            $('.special-panel').attr('aria-hidden', 'true');
            setTimeout(function() {
              window.dispatchEvent(new Event('resize'));
            }, 0);
          }
          panel_toggle.state('open-webgl');
        }

        // resize the webGL canvas
        var resize_webgl = function() {
          var $panel= $(".special-panel");
          var h = $panel.height();
          var w = $panel.width();

          var r = w / 1024;
          var width = w + 'px';
          var height = Math.ceil(600 * r) + 'px';

          var $g = $('#gameContainer');
          $g.css({ width: width, height: height });
          var $c = $g.find('canvas').get(0);
          $c.setAttribute('width', parseInt(width));
          $c.setAttribute('height', parseInt(height));
        }

        // dynamic WebGL canvas resizing
        reader.on('resized', function() {
          // mobile users shouldn't have a canvas to resize
          if (gameReady && heliotropeIncompatibleWebGlUser === false) {
            resize_webgl();
          }
        })

        // Open SU panel in WebGL if SU link is clicked
        // If in a11y mode, open database record
        var click_handler = function(event) {
          var s = event.target.getAttribute('data-uid');
          if ($('body').hasClass('a11y')) {
            window.open('https://doi.org/10.3998/gabii.1.' + s, '_blank');
          } else {
            var SendMessage = gameInstance.SendMessage;
            var $panel= $(".special-panel");
            function getToUnity(s) {
              SendMessage("WebCommunicator", "ShowString", s);
            };
            var gameContainerDiv = document.getElementById("gameContainer");
            if ($('body').hasClass('panel-open')) {
              FocusCanvas("1");
              gameContainerDiv.focus();
              getToUnity(s);
            } else {
              open_panel();
              FocusCanvas("1");
              gameContainerDiv.focus();
              getToUnity(s);
            }
          }
        };

        // Setup SU link event listener
        reader.on('ready:contents', function(contents) {
          var links = contents.content.querySelectorAll("a[data-uid]");
          for(var i =0, n = links.length; i < n; i++) {
            var link = links[i];
            link.addEventListener('click', click_handler);
          }
        })

        // Toggling focus of canvas - if clicked on canvas, focus
        // if clicked outside of canvas, remove focus
        // if tab advance after focusing canvas, remove canvas focus
        function GameControlReady () {
          gameReady = true;
        }

        function FocusCanvas(focus) {
          if (gameReady) {
            var SendMessage = gameInstance.SendMessage;
            SendMessage("GameControl", "FocusCanvas", focus);
          }
        }

        document.addEventListener('click', function(e) {
          if (e.target.id == "#canvas") {
            // Clicked on canvas
            FocusCanvas("1");
              } else {
            // Clicked outside of canvas
            FocusCanvas("0");
          }
        });

        document.addEventListener('keydown', function(event) {
          if (event.defaultPrevented) {
            return; // Do nothing if the event was already processed
          }

          switch (event.key) {
            case "Tab":
              FocusCanvas("0");
            break;
            default:
            return;
          }

        }, true);

        // POI to CFI webgl -> epub mapping stuff
        var poiToCfiMap = {};

        var fetch_poi = function() {
          $.get("<%= "#{epub_file_path(id: @presenter.id, file: 'epub-webgl-map.json')}" %>", function(data) {
            data.forEach(function(map) {
              poiToCfiMap[map['poi']] = map['cfi']
            })
          });
        }
        // Take user to a POI when passed a string from WebGL
        function goToParagraph(p) {
          var par = "par" + p;
          if (poiToCfiMap[par]) {
            console.log("CFI " + poiToCfiMap[par] + " found for POI " + par);
            reader.gotoPage('epubcfi(' + poiToCfiMap[par] + ')');
          } else {
            console.log("No CFI found for POI " + par);
          };
        }

        // 3D model toggler
        var panel_toggle = cozy.control.widget.toggle({
          region: 'top.toolbar.left',
          template: '<button class="button--sm" id="webgl" data-toggle="button" aria-label="3D Model">3D Model</button>',
          states: [{
            stateName: 'open-webgl',
            onClick: function(btn, reader) {
              open_panel();
              btn.state('close-webgl');
            }
          },
            {
              stateName: 'close-webgl',
              onClick: function(btn, reader) {
                close_panel();
                btn.state('open-webgl');
              }
            }],
        })
        panel_toggle.addTo(reader);

        // accessibility mode on/off
        var a11y_on = function() {
          $('body').addClass('a11y');
          $('#webgl').attr('aria-disabled', 'true');
          $('#webgl').prop('disabled', true);
          // a flag (set above) to allow the WebGL panel, with an incompatibility message, to be open with a11y_on...
          // mode on initial load *only* for users with an incompatible device/browser
          if(firstLaunchWebGlEpub === true)
            firstLaunchWebGlEpub = false;
          else if($('.special-panel').prop('hidden') == false) // the user might have closed this manually
            close_panel();
        }

        var a11y_off = function() {
          $('body').removeClass('a11y');
          $('.toggle-a11y').removeClass('on');
          $('#webgl').attr('aria-disabled', 'false');
          $('#webgl').prop('disabled', false);

          open_panel();
        }

        <% else %>
        // no-op for epubs without a webgl (so... almost all of them)
        var fetch_poi = function() { }
        <% end %>

        // Database
        // This is a very specific case of an externally hosted database that is related to the epub
        <% if @monograph_presenter.database? %>
        cozy.control.widget.button({
          region: 'top.toolbar.left',
          template: '<button class="button--sm" data-toggle="button" aria-label="Database">Database</button>',
          onClick: function() { window.location = "<%= "#{@monograph_presenter.database['ext_url_doi_or_handle_ssim'].first}" %>"; }
        }).addTo(reader);
        <% end %>

        // Media
        <% if @monograph_presenter.assets? %>
        cozy.control.widget.button({
          region: 'top.toolbar.left',
          template: '<button class="button--sm" data-toggle="button" aria-label="Media">Media</button>',
          onClick: function() { window.location = "<%= "#{main_app.monograph_catalog_url(@presenter.monograph_id) + "#media"}" %>"; }
        }).addTo(reader);
        <% end %>

        // Permalink widget
        cozy.control.widget.panel({
          region: 'top.toolbar.left',
          data: { title: "<%= @citable_link %>"},
          template: '<div class="permalink-label"><label class="u-screenreader" for="permalink">Permalink</label><form><input data-slot="title" type="text" id="permalink" value="" readonly="readonly" onclick="this.select(); document.execCommand(\'copy\');"></form></div>',
        }).addTo(reader);

        <% if @monograph_presenter.citations_ready? %>
        // Citation widget
        // see: https://github.com/mlibrary/cozy-sun-bear/wiki/Metadata-and-Citations
        var my_citations = [
          {format: 'MLA', text: "<%= export_as_mla_citation(@monograph_presenter).gsub('"', '\"').html_safe %>" },
          {format: 'APA', text: "<%= export_as_apa_citation(@monograph_presenter).gsub('"', '\"').html_safe %>" },
          {format: 'Chicago', text: "<%= export_as_chicago_citation(@monograph_presenter).gsub('"', '\"').html_safe %>" }
        ]
        cozy.control.citation({ region: 'top.toolbar.left', citations: my_citations }).addTo(reader);
        <% end %>

        // Search widget
        <% unless Heliotrope::Application.config.cozy_epub_engine == 'readium' %>
        cozy.control.search({
          region: 'top.toolbar.left',
          searchUrl: "<%= @search_url %>"
        }).addTo(reader);
        <% end %>

        // Share widget
        cozy.control.widget.button({
          region: 'top.toolbar.left',
          template: '<div class="btn-group"><button class="button--sm dropdown-toggle" data-toggle="dropdown" aria-label="Share book" aria-haspopup="true" aria-expanded="false"><i id="share" class="icon-share-boxed oi" data-glyph="share-boxed" title="Share book" aria-hidden="true"></i></button><ul class="dropdown-menu"><li><a href="http://twitter.com/intent/tweet?text=<%= @monograph_presenter.page_title %>&amp;url=<%= @citable_link %>" target="_blank">Twitter</a></li><li><a href="http://www.facebook.com/sharer.php?u=<%= @citable_link %>&amp;t=<%= @monograph_presenter.page_title %>" target="_blank">Facebook</a></li><li><a href="https://plus.google.com/share?url=<%= @citable_link %>" target="_blank">Google+</a></li><li><a href="http://www.reddit.com/submit?url=<%= @citable_link %>" target="_blank">Reddit</a></li><li><a href="http://www.mendeley.com/import/?url=<%= @citable_link %>" target="_blank">Mendeley</a></li><li><a href="http://www.citeulike.org/posturl?url=<%= @citable_link %>&amp;title=<%= @monograph_presenter.page_title %>" target="_blank">Cite U Like</a></li></ul></div>'
        }).addTo(reader);

        // Download widget
        <% if @epub_download_presenter.download_links.length.positive? %>
        cozy.control.download({
            region: 'top.toolbar.left',
            template: '<button class="button--sm cozy-download" data-toggle="open" aria-label="Download book" role="button"><i id="download" class="oi" data-glyph="data-transfer-download" title="Download book" aria-hidden="true"></i></button>',
        }).addTo(reader);
        <% end %>

        // Fullscreen widget
        cozy.control.widget.button({
          region: 'top.toolbar.right',
          className: 'cozy-container-fullscreen',
          template: '<button class="button--sm" data-toggle="button" data-slot="label" aria-label="Full screen"></button>',
          data: { label: '<i id="fullscreen" class="icon-fullscreen-enter oi" data-glyph="fullscreen-enter" title="Fullscreen Mode" aria-hidden="true"></i>' },
          onClick: function() {
            reader.requestFullscreen();
            if (!window.screenTop && !window.screenY) {
              $('#fullscreen').attr('data-glyph', 'fullscreen-enter');
            } else {
              $('#fullscreen').attr('data-glyph', 'fullscreen-exit');
            }
          }
        }).addTo(reader);

        // Reading preferences widget - webgl gets custom preferences
        <% if @monograph_presenter.webgl? %>
        // Add accessibility mode to preferences
        cozy.control.preferences({
          region: 'top.toolbar.right',
          fields: [
            {
              label: 'Accessibility Mode',
              name: 'accessibility-mode',
              inputs: [
                { value: 'off', label: 'Off' },
                { value: 'on', label: 'On'}
              ],
              value: heliotropeIncompatibleWebGlUser === true ? 'on' : 'off',
              callback: function(value) {
                if (value == 'on') {
                  a11y_on();
                } else {
                  a11y_off();
                }
              },
              hint: 'When Accessibility Mode is "On", the publication is read without the 3D model. All links to stratigraphic units point to external database records.'
            }
          ]
        }).addTo(reader);
        <% else %>
        cozy.control.preferences({ region: 'top.toolbar.right' }).addTo(reader);
        <% end %>

        // Paging widgets
        // cozy.control.pageFirst({ region: 'left.sidebar' }).addTo(reader);
        cozy.control.pagePrevious({ region: 'left.sidebar' }).addTo(reader);
        cozy.control.pageNext({ region: 'right.sidebar' }).addTo(reader);
        // cozy.control.pageLast({ region: 'right.sidebar' }).addTo(reader);
        // cozy.control.navigator({ region: 'book.navigator' }).addTo(reader);

        // Publisher/copyright widgets
        // cozy.control.publicationMetadata({ region: 'bottom.footer' }).addTo(reader);

        // Feedback widget
        cozy.control.widget.panel({
          region: 'bottom.navigator.left',
          className: 'cozy-panel-feedback',
          <% if @monograph_presenter.webgl? %>
          template: '<a href="https://docs.google.com/forms/d/e/1FAIpQLSehtWeYRAmb12pLcQV0WXDvsQgdEsI6H-gbj4HumdySrmwhZg/viewform?usp=sf_link" target="_blank" title="Report a problem or share feedback"><i class="icon-comment-square oi" data-glyph="comment-square" aria-hidden="true"></i></a>',
          <% else %>
          template: '<a href="https://docs.google.com/forms/d/e/1FAIpQLSeY04WhBtHGSXONu3jGiYnOcVzZxzHi3FGbS9ELg8rJdMpgpw/viewform?usp=sf_link" target="_blank" title="Report a problem or share feedback"><i class="icon-comment-square oi" data-glyph="comment-square" aria-hidden="true"></i></a>',
          <% end %>
        }).addTo(reader);

        // Navigator widgets
        cozy.control.navigator({ region: 'bottom.navigator' }).addTo(reader);

        // Initiate EPUB Reader
        reader.start(fetch_poi);
      }
    </script>
  </div>
  <%= render 'shared/ga' %>
<% end %>
<%= render template: 'layouts/boilerplate' %>
